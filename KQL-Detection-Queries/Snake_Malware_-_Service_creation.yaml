Detection rule: Snake_Malware_-_Service_creation

Description: |
    This rule detects the creation of service named "WerFaultSvc" which is a Snake malware signature persistence mechanism.
    According to CISA report : 
    "The Snake version primarily discussed in this advisory registers a service to maintain persistence on a system. Typically, this service is named “WerFaultSvc” 
    which we assess was used to blend in with the legitimate Windows service WerSvc. On boot, this service will execute Snake’s WerFault.exe, 
    which Snake developers chose to hide among the numerous valid Windows “WerFault.exe” files in the %windows%\WinSxS\ directory. 
    Executing WerFault.exe will start the process of decrypting Snake’s components and loading them into memory"

    Action to perform:
    - Analyze the file being executed (known hash/signature/origin etc )
    - Analyze the process lineage

    More info: https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a

Technique IDs: 
    - T1569

KQL query: |
    DeviceEvents
    | where ActionType has "ServiceInstalled"
    | extend ServiceName = tostring(parse_json(AdditionalFields).ServiceName)
    | extend ServiceAccount = tostring(parse_json(AdditionalFields).ServiceAccount)
    | extend ServiceStartType = tostring(parse_json(AdditionalFields).ServiceStartType)
    | extend ServiceType = tostring(parse_json(AdditionalFields).ServiceType)
    | where ServiceName contains "WerFaultSvc"