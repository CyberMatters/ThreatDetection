Detection rule: Post-exploitation_SLIVER_-_Interactive_shell

Description: |
    This rule triggers an alert when the console output format is set to UTF-8.
    The standard output format is : "System.Text.SBCSCodePageEncoding".

    When an attacker is using to post-exploitation tool Sliver and request an interactive shell session from the victim (via the agent called implant), 
    the implant spawns an instance of powershell and change the output format.

    Reminder: this could be seen in Windows Event log 4104 on the device. (LiveResponse required)

    Action to perform:
    - Analyze the process lineage
    - analyze the network connections from the parents and the powershell process? 
        - any sign of C2 communications ? 
        - suspicious remote host ? beaconing ?
        - Collect the powershell logs (4103,4104) of the device and analyze the command that were run after changing the output of the console.

    More info : 
    - https://bishopfox.com/blog/sliver
    - https://github.com/BishopFox/sliver/wiki/Getting-Started
    - https://www.techrepublic.com/article/sliver-offensive-security-framework-increasingly-used-by-threat-actors/
    - https://www.ncsc.gov.uk/files/Advisory%20Further%20TTPs%20associated%20with%20SVR%20cyber%20actors.pdf
    - https://www.microsoft.com/en-us/security/blog/2022/08/24/looking-for-the-sliver-lining-hunting-for-emerging-command-and-control-frameworks/
    - https://www.youtube.com/watch?v=izMMmOaLn9g

Technique IDs: 
    - T1059.001
    - T1071.001
    - T1071.004

KQL query: |
    //Detects Sliver interactive shell session
    DeviceProcessEvents
    | where FileName has_any ("powershell.exe","pwsh.exe")
    | where ProcessCommandLine contains "-Command [Console]::OutputEncoding=[Text.UTF8Encoding]::UTF8"